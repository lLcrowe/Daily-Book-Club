# 4장) 프로그램의 구조와 실행

# 프로그램 구조와 인터럽트

---

프로그램이 CPU에서 명령을 수행하려면 해당 명령을 담은 프로그램의 주소 영역이 메모리에 올라가 있어야 한다.

## 프로그램의 주소 영역

코드(code), 데이터(data), 스택(stack) 영역으로 구분된다.

### 코드(code)

- 우리가 작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령(machine instruction) 형태로 변환되어 저장되는 부분

### 데이터(data)

- 전역 변수(global variable) 등 프로그램이 사용하는 데이터를 저장하는 부분

### 스택(stack)

- 함수가 호출될 때 호출된 함수의 수행을 마치고 복귀할 주소 및 데이터를 임시로 저장하는 데에 사용되는 공간

## 인터럽트 - 프로세스 제어블록

- 인터럽트의 동작 원리도 함수의 호출과 비슷하다.
- 인터럽트 때문에 CPU를 빼앗긴 위치는 운영체제가 관리하는 프로세스 제어블록에 저장된다.
    - 인터럽트가 발생한 시점에서 그 프로그램의 어느 부분까지 수행했는지를 저장한다.
    - 인터럽트 처리 후 프로세스 제어블록에 저장된 주소를 복원시켜 원래 수행하던 일을 재개하게 된다.

# 컴퓨터 시스템의 작동 개요

---

CPU는 컴퓨터의 두뇌가 아니라, 매 시점 메모리의 특정 주소에 존재하는 명령을 하나씩 읽어와 빠른 속도로 처리하는 계산할 뿐이다.

- 어떠한 작업을 수행해야 하는지 스스로 결정하는 능력이 없다.
- CPU가 수행해야 할 메모리 주소를 담고 있는 레지스터를 **프로그램 카운터**(Program Counter: PC)라고 부른다.
    - 즉, CPU는 매번 프로그램 카운터가 가리키는 메모리 위치의 명령을 처리하게 된다.
    - 일반적으로 조건문, 반복문, 함수호출 등에 의한 주소 이동이 없는 이상 프로그램 카운터는 항상 바로 다음 명령을 가리키게 되어 코드의 순차적인 수행이 이루어진다.

## 컴퓨터 시스템 구성

컴퓨터 시스템을 구성하는 하드웨어로는 CPU와 메모리가 있고, 이 밖에 각 입출력 장치와 이들 장치를 전담하는 작은 CPU와 메모리가 있다.

- 입출력 장치별로 존재하는 작은 CPU와 메모리를 각각 입출력 컨트롤러와 로컬버퍼라고 부른다.
- 메모리에는 사용자 프로그램들과 운영체제가 같이 올라가 수행된다.

### CPU가 수행하는 명령

1. 일반명령
    - 메모리에서 자료를 읽어와 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령
    - 일반명령은 모든 프로그램이 수행할 수 있는 명령
2. 특권명령
    - 보안이 필요한 명령으로 입출력 장치, 타이머 등 각종 장치에 접근하는 명령
    - 컴퓨터 시스템에서는 특권명령을 항상 운영체제만이 수행할 수 있도록 제한하고 있다.

이 두 명령의 실행가능성을 체크하기 위해 CPU 내에 모드비트(mode bit)를 둔다.

사용자 프로그램은 스스로 특권명령을 수행할 수 없으므로 운영체제에게 특권명령의 대행을 요청한다. 이와 같은 서비스 요청을 **시스템 콜(system call)**이라고 부른다.

# 프로그램의 실행

---

‘프로그램이 실행(program execution) 되고 있다’는 것은 컴퓨터 시스템 차원에서 볼 때 크게 두 가지 중요한 의미를 가진다.

1. 디스크에 존재하던 실행파일이 메모리에 적재된다는 의미
2. 프로그램이 CPU를 할당받고 명령(instruction)을 수행하고 있는 상태라는 의미

![Untitled](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/6ee5336b-18b8-4a5f-bc6b-fb03b48d6ad9/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230220%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230220T042734Z&X-Amz-Expires=86400&X-Amz-Signature=f149fec944d705383b0599668054948bc7648afc26eb735e201726777b9f646b&X-Amz-SignedHeaders=host&response-content-disposition=filename%3D%22Untitled.png%22&x-id=GetObject)

프로그램이 주소 공간 중 당장 CPU의 수행에 필요한 부분은 메모리에 올려놓고 그렇지 않은 부분은 디스크 중 메모리의 연장 공간으로 사용되는 **스왑 영역**에 내려놓은 방식으로 운영된다.

### 가상 메모리(virtual memory)

프로그램마다 독자적으로 존재하는 주소공간.

논리적 메모리(logical memory)라고도 부른다.

- 실제 물리적 메모리의 주소와 독립적으로 각 프로그램마다 독자적인 주소 공간을 가지기 때문에 지칭하는 용어

![다운로드.png](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/01cfbebe-7acd-4618-a08c-661831dc84fb/%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230220%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230220T042715Z&X-Amz-Expires=86400&X-Amz-Signature=28a6378b5f22069d3952e18e8229abe56a4a54edd8b3bfca65da81b6297d87cb&X-Amz-SignedHeaders=host&response-content-disposition=filename%3D%22%25EB%258B%25A4%25EC%259A%25B4%25EB%25A1%259C%25EB%2593%259C.png%22&x-id=GetObject)

### 커널의 주소 공간

운영체제 커널 역시 코드, 데이터, 스택의 주소 공간 구서을 가진다.

- 데이터 영역
    - 각종 자원을 관리하기 위한 자료구조가 저장된다.
    - CPU나 메모리와 같은 하드웨어 자원을 관리하기 위한 자료구조뿐 아니라 현재 수행 중인 프로그램을 관리하기 위한 자료구조도 커널의 데이터 영역에 유지된다.
    - 현재 수행 중인 프로그램을 **프로세스(Process)**라고 부르고, 커널의 데이터 영역 내에는 각 프로세스의 상태, CPU 사용 정보, 메모리 사용 정보 등을 유지하기 위한 자료구조인 PCB를 두고 있다.
    - 하드웨어 소프트웨어를 포함하는 시스템 내의 모든 자원을 관리하기 위한 자료구조를 각각 유지하고 있다.

- 스택
    - 일반 사용자 프로그램의 스택과 달리 현재 수행 중인 프로세스마다 별도의 스택을 두어 관리한다.
    - 프로세스가 함수를 호출할 때 자기 주소 영역 내부에 정의된 함수를 호출하면 자신의 스택에 복귀 주소를 저정하지만, 프로세스가 특권명령을 수행하려고 커널에 정의된 시스템 콜을 호출하고 시스템 콜 내부에서 다른 함수를 호출하는 경우 그 복귀 주소는 커널 내의 주소가 되어 사용자 프로그램의 스택과는 별도의 저장공간이 필요하게 되기 때문이다.
    - 커널은 일종의 공유 코드로서 모든 사용자 프로그램이 시스템 콜을 통해 커널의 함수를 접근할 수 있으므로, 일관성 유지를 위해 각 프로세스마다 커널 내에 별도의 스택을 두게 되는 것이다.
    - 정리하자면 프로그램이 자기 자신의 코드 내에서 함수호출 및 복귀 주소를 유지하기 위해서는 자기 주소 공간 내의 스택을 사용하고, 시스템 콜이나 인터럽트 등으로 운영체제의 코드가 실행되는 중에 함수호출이 발생할 경우 커널 스택을 사용하게 되는 것이다.
    - 시스템 콜이나 인터럽트 발생으로 CPU의 수행 주체가 운영체제로 바뀌는 순간에는 직전에 수행되던 프로그램의 복귀 정보를 스택이 아닌 PCB에 저장한다.


# 사용자 프로그램이 사용하는 함수

---

프로그램이 사용하는 함수는 크게 **사용자 정의 함수**와 **라이브러리 함수**, **커널 함수**의 세 가지로 구분해 볼 수 있다.

- 사용자 정의 함수
    - 프로그래머 본인이 직접 작성한 함수
- 라이브러리 함수
    - 프로그래머 본인이 직접 작성하지는 않았지만, 이미 누군가 작성해놓은 함수를 호출만 하여 사용하는 경우를 뜻한다.


사용자 정의 함수와 라이브러리 함수는 모두 그 프로그램의 코드 영역에 기계어 명령 형태로 존재한다. 이 두 함수는 프로그램이 실행될 때에 해당 프로세스의 주소 공간에 포함되며, 또한 함수호출 시에도 자신의 주소 공간에 있는 스택을 사용하게 된다.

- 커널 함수
    - 운영체제 커널의 코드에 정의된 함수를 뜻한다.
    - 커널 함수의 종류에는 시스템 콜 함수, 인터럽트 처리 함수가 있다.
        - 시스템 콜 함수 : 사용자 프로그램이 운영체제의 서비스를 요청하기 위해 호출하는 시스템 콜 함수
        - 인터럽트 처리 함수 : 각종 하드웨어 및 소프트웨어가 CPU의 서비스를 요청하기 위해 발생시키는 인터럽트 처리 함수


일반적인 함수 호출 : 사용자 프로그램 내에 존재하는 코드를 실행

시스템 콜 : 사용자 프로그램이 아닌 운영체제라는 별개의 프로그램에 CPU를 넘겨서 실행

# 인터럽트

---

CPU는 특별한 일이 없으면 현재 수행 중인 프로세스의 명령을 순차적으로 수행한다.

- CPU는 매번 프로그램 카운터가 가리키는 곳에 있는 명령을 수행하는 일밖에 하지 않는다.
- 현재 수행 중인 프로세스로부터 CPU를 회수해 CPU가 다른 일을 수행하도록 하기 위해서는 인터럽트 메커니즘이 필요하다.
- 원칙적으로 인터럽트 처리 중에 또 다른 인터럽트가 발생하는 것을 허용하지 않는다.
    - 인터럽트 처리 중에 다른 인터럽트를 처리하면 데이터의 일관성이 유지되지 않는 문제 발생할 수 있다.
    - 인터럽트마다 중요도가 다르기 때문에 상대적으로 낮은 중요도를 가진 인터럽트를 처리하는 도중에 중요도가 더 높은 인터럽트가 발생할 수 있다.

# 시스템 콜

---

모든 프로그램은 자기 자신의 독자적인 주소 공간을 가지고 있으며, 프로그램이 함수호출을 하는 경우 자신의 주소 공간 내에서 호출이 이루어지게 된다.

그러나 시스템 콜은 비록 함수호출이기는 하지만 자신의 주소 공간을 거스르는 영역에 존재하는 함수를 호출하는 것을 말한다.

## 일반적인 함수 호출과 다른점

일반적인 함수호출이 자신의 스택에 복귀 주소를 저장한 후 호출된 함수 위치로 점프하는 것임에 비해, 주소 공간 자체가 다른 곳으로 이동해야 하므로 일반 함수호출과는 상이한 방법을 사용한다.

## 인터럽트의 함수 호출 방법

프로그램 자신이 인터럽트 라인에 인터럽트를 세팅하는 명령을 통해 이루어진다.

→ 프로그램이 스스로 인터럽트 라인을 세팅한다는 점만 다를 뿐 일반적인 인터럽트의 발생과 동일한 방법이라 할 수 있다.

## 시스템 콜 사용의 예

디스크의 파일 입출력이 이루어지는 과정을 통해 보는 시스템 콜 사용의 예

1. 사용자 프로그램이 CPU에서 명령을 수행하던 중 디스크의 파일을 읽어와야 할 경우 시스템 콜로 커널의 함수를 호출하게 된다.
2. 입출력 함수의 호출이 자신의 주소 공간에서 이루어질 수 없기 때문에 사용자 프로그램은 CPU의 제어권을 운영체제에게 이양하게 되는데, 이는 인터럽트 라인을 세팅하는 명령을 통해 이루어진다.
3. 인터럽트 라인이 세팅되면 CPU는 다음 명령을 수행하기 전에 인터럽트가 발생했는지 점검하게 되며, 이 과정에서 인터럽트가 발생한 것을 인지하고 현재 수행 중인 사용자 프로그램을 잠시 멈춘 후 CPU의 제어권을 운영체제로 이양시키게 된다.
4. 운영체제는 설정된 인터럽트 라인에 의해 이번에 발생한 인터럽트가 입출력을 요청하는 인터럽트임을 인지하게 된다. 그런 다음 해당 서비스루틴으로 이동해 입출력 작업을 수행하게 된다.
5. 이 과정에서 CPU는 디스크 컨트롤러에게 파일을 읽어오라는 명령을 하게 된다.

## CPU를 하다가 중간에 CPU를 빼앗기는 경우

1. 타이머에 의해 인터럽트가 발생하는 경우
    - 특정 프로그램에 의해 CPU가 독점되는 것을 방지하기 위한 하드웨어
    - CPU 할당 시간이 만료되면 인터럽트를 발생시킨다.
    - 이러한 타이머는 여러 프로세스가 CPU를 나누어 사용하는 시분할 시스템의 구현을 위한 필수적인 요소라 할 수 있다.
2. 입출력 요청을 위해 시스템 콜을 하는 경우
    1. 시간이 오래 걸리는 입출력 작업이 완료되기까지 그 프로세스에게 CPU를 다시 할당하더라도 당장 다음 명령을 수행하지 못하는 경우가 일반적이므로 CPU를 다른 프로세스에게 이양하게 된다.
    2. 입출력을 요청했던 프로세스는 입출력 요청이 완료된 후 컨트롤러가 인터럽트를 발생시킨 시점부터 다시 CPU를 얻을 수 있는 자격을 부여받게 된다.

# 프로세스의 두 가지 실행 상태

---

프로그램이 시작되어 종료될 때까지 다양한 함수호출을 하며 실행되는데,

이를 사용자모드와 커널모드의 실행 상태로 구분 지을 수 있다.